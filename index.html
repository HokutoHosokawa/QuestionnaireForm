<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <!-- ▼▼▼ GitHub Pages用リダイレクト処理 ▼▼▼ -->
    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            const path = params.get('path');
            if (path) {
                const repoPath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
                window.history.replaceState(null, '', repoPath + path);
            }
        })();
    </script>
    <!-- ▲▲▲ ここまで ▲▲▲ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アンケートフォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .required-label::after { content: '*'; color: #ef4444; margin-left: 0.25rem; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; }
        input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="password"], textarea, select { padding: 0.5rem 0.75rem !important; }
        .matrix-cell-label { display: block; padding: 0.5rem; cursor: pointer; }
        .matrix-cell-label input { margin-right: 0.5rem; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen py-8">

    <div id="loading-spinner" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <!-- ▼▼▼ アンケート回答画面 ▼▼▼ -->
    <main id="app-container" class="hidden container mx-auto p-4 max-w-4xl w-full my-8">
         <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div id="form-header" class="border-b pb-4 mb-6">
                <h1 id="form-title" class="text-3xl sm:text-4xl font-bold text-gray-900"></h1>
                <p id="form-description" class="mt-2 text-gray-600"></p>
            </div>
            <div id="error-display" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">エラー:</strong>
                <span id="error-display-message" class="block sm:inline"></span>
            </div>
            <form id="quiz-form" onsubmit="return false;">
                <div id="questions-container" class="space-y-8"></div>
            </form>
            <div id="progress-container" class="mt-8">
                <p id="progress-text" class="text-center text-sm font-medium text-gray-600"></p>
            </div>
            <div id="navigation-controls" class="mt-8 flex justify-between items-center">
                <button id="prev-btn" type="button" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">戻る</button>
                <button id="next-btn" type="button" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">次へ</button>
                <button id="submit-btn" type="button" class="hidden bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">送信</button>
            </div>
        </div>
    </main>

    <div id="thank-you-message" class="hidden text-center bg-white p-10 rounded-2xl shadow-lg max-w-2xl mx-auto">
        <h2 class="text-3xl font-bold text-green-600 mb-4">ご協力ありがとうございました！</h2>
        <p class="text-gray-700">アンケートへの回答が正常に送信されました。</p>
    </div>

    <!-- ▼▼▼ ログイン画面 ▼▼▼ -->
    <div id="login-container" class="hidden container mx-auto p-4 max-w-md w-full my-8">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <h1 class="text-2xl font-bold text-gray-900 text-center">管理者ログイン</h1>
            <div id="login-error-display" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg" role="alert"></div>
            <div class="space-y-6 mt-6">
                <div>
                    <label for="email-input" class="block text-md font-medium text-gray-800">メールアドレス</label>
                    <input type="email" id="email-input" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label for="password-input" class="block text-md font-medium text-gray-800">パスワード</label>
                    <input type="password" id="password-input" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">ログイン</button>
            </div>
        </div>
    </div>

    <!-- ▼▼▼ 管理画面 ▼▼▼ -->
    <div id="admin-container" class="hidden container mx-auto p-4 max-w-2xl w-full my-8">
        <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <div>
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">アンケート管理</h1>
                    <p class="mt-2 text-gray-600">JSONファイルをアップロードしてアンケートを作成・更新します。</p>
                </div>
                <button id="logout-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">ログアウト</button>
            </div>
            <div id="admin-error-display" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">エラー:</strong>
                <span id="admin-error-message" class="block sm:inline"></span>
            </div>
            <div id="admin-success-display" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                 <span id="admin-success-message" class="block sm:inline"></span>
            </div>
            <div class="space-y-6">
                <div>
                    <label for="json-upload-input" class="block text-md font-medium text-gray-800 required-label">アンケートJSONファイル</label>
                    <p class="text-sm text-gray-500 mt-1">アンケートの構造を定義したJSONファイルを選択してください。</p>
                    <input type="file" id="json-upload-input" accept=".json" class="mt-2 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div>
                    <label for="survey-id-input" class="block text-md font-medium text-gray-800 required-label">アンケートURLの末尾</label>
                    <p class="text-sm text-gray-500 mt-1">このアンケートにアクセスするためのURLの末尾の文字列を入力してください (例: survey2024)。英数字とハイフン(-)のみ使用できます。</p>
                    <div class="mt-2 flex rounded-md shadow-sm">
                        <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">.../</span>
                        <input type="text" id="survey-id-input" placeholder="my-awesome-survey" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-blue-500 focus:border-blue-500 sm:text-sm border-gray-300">
                    </div>
                </div>
                <div>
                    <button id="save-survey-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">保存してURLを生成</button>
                </div>
            </div>
        </div>
    </div>


    <!-- ▼▼▼ メインのJavaScript処理 ▼▼▼ -->
    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- Firebase設定 ---
        const firebaseConfig = {
            apiKey: "AIzaSyBPVmVHYilSNRCBPapItOZyOUFAwLe8nY4",
            authDomain: "game-of-questionnaire.firebaseapp.com",
            projectId: "game-of-questionnaire",
            storageBucket: "game-of-questionnaire.firebasestorage.app",
            messagingSenderId: "70165208444",
            appId: "1:70165208444:web:7b296d37d395540d1658f9"
        };

        // --- Firebaseの初期化 ---
        let db, auth;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebaseの初期化に失敗しました。", e);
            document.getElementById('loading-spinner').style.display = 'none';
            document.body.innerHTML = '<p>Firebaseの初期化に失敗しました。設定を確認してください。</p>';
        }

        // --- アンケートJSONデータ ---
        let surveyJSONData = {};

        // --- DOM要素 ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const appContainer = document.getElementById('app-container');
        const adminContainer = document.getElementById('admin-container');
        const loginContainer = document.getElementById('login-container');
        const thankYouMessage = document.getElementById('thank-you-message');
        const errorDisplay = document.getElementById('error-display');
        const errorDisplayMessage = document.getElementById('error-display-message');
        const formTitleEl = document.getElementById('form-title');
        const formDescriptionEl = document.getElementById('form-description');
        const questionsContainer = document.getElementById('questions-container');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const progressText = document.getElementById('progress-text');

        // --- 状態管理 ---
        let answers = {};
        let pageHistory = [];
        let currentPageIndex = 0;

        // --- 初期化ロジック ---
        document.addEventListener('DOMContentLoaded', main);

        function main() {
            const pathSegments = window.location.pathname.split('/').filter(p => p && p !== 'index.html');
            const repoName = pathSegments.length > 0 ? pathSegments[0] : null;
            const surveyId = pathSegments.length > 1 ? pathSegments[pathSegments.length - 1] : null;

            // URLがルートパス、またはリポジトリ名のみの場合
            if (!surveyId || surveyId === repoName) {
                setupAuthObserver();
            } else {
                // 通常のアンケート表示処理
                displaySurvey(surveyId);
            }
        }

        function setupAuthObserver() {
            onAuthStateChanged(auth, user => {
                loadingSpinner.style.display = 'none';
                if (user) {
                    loginContainer.classList.add('hidden');
                    displayAdminInterface();
                } else {
                    adminContainer.classList.add('hidden');
                    displayLoginInterface();
                }
            });
        }

        function displayLoginInterface() {
            loginContainer.classList.remove('hidden');
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
            }
        }
        
        function displayAdminInterface() {
            adminContainer.classList.remove('hidden');
            const saveSurveyBtn = document.getElementById('save-survey-btn');
            const logoutBtn = document.getElementById('logout-btn');
            if (saveSurveyBtn) saveSurveyBtn.addEventListener('click', handleSaveSurvey);
            if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        }

        async function displaySurvey(surveyId) {
             try {
                const surveyDocRef = doc(db, 'surveys', surveyId);
                const surveyDocSnap = await getDoc(surveyDocRef);

                if (!surveyDocSnap.exists()) {
                    throw new Error(`指定されたアンケートID "${surveyId}" はデータベースに見つかりませんでした。`);
                }

                surveyJSONData = surveyDocSnap.data();

                if (!surveyJSONData || !surveyJSONData.title || !surveyJSONData.question_groups) {
                    throw new Error(`アンケートID "${surveyId}" のデータ形式が正しくありません。`);
                }

                appContainer.classList.remove('hidden');
                formTitleEl.textContent = surveyJSONData.title;
                formDescriptionEl.textContent = surveyJSONData.description;

                const firstGroupId = surveyJSONData.question_groups[0]?.id;
                if (firstGroupId) {
                    generatePage(firstGroupId, 0);
                } else {
                    throw new Error("アンケートに質問グループが見つかりません。");
                }

            } catch (error) {
                console.error('アンケートの初期化に失敗しました:', error);
                showError(`${error.message}`);
            } finally {
                loadingSpinner.style.display = 'none';
                if (!surveyJSONData.title) {
                    appContainer.classList.add('hidden');
                }
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const errorDisplay = document.getElementById('login-error-display');
            errorDisplay.classList.add('hidden');

            if (!email || !password) {
                errorDisplay.textContent = 'メールアドレスとパスワードを入力してください。';
                errorDisplay.classList.remove('hidden');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("ログインエラー:", error);
                errorDisplay.textContent = 'ログインに失敗しました。メールアドレスまたはパスワードが正しくありません。';
                errorDisplay.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("ログアウトエラー:", error);
                alert("ログアウトに失敗しました。");
            }
        }

        async function handleSaveSurvey() {
            const adminErrorDisplay = document.getElementById('admin-error-display');
            const adminErrorMessage = document.getElementById('admin-error-message');
            const adminSuccessDisplay = document.getElementById('admin-success-display');
            const adminSuccessMessage = document.getElementById('admin-success-message');
            const jsonUploadInput = document.getElementById('json-upload-input');
            const surveyIdInput = document.getElementById('survey-id-input');
            const saveSurveyBtn = document.getElementById('save-survey-btn');

            adminErrorDisplay.classList.add('hidden');
            adminSuccessDisplay.classList.add('hidden');
            saveSurveyBtn.disabled = true;
            saveSurveyBtn.textContent = '保存中...';

            const surveyId = surveyIdInput.value.trim();
            const jsonFile = jsonUploadInput.files[0];

            const showAdminError = (message) => {
                adminErrorMessage.textContent = message;
                adminErrorDisplay.classList.remove('hidden');
                saveSurveyBtn.disabled = false;
                saveSurveyBtn.textContent = '保存してURLを生成';
            };

            if (!surveyId || !jsonFile) {
                showAdminError("アンケートURLの末尾とJSONファイルの両方を指定してください。");
                return;
            }
            if (!/^[a-zA-Z0-9-]+$/.test(surveyId)) {
                showAdminError("URLの末尾には英数字とハイフン(-)のみ使用できます。");
                return;
            }
            if (jsonFile.type !== 'application/json') {
                showAdminError("JSONファイル (.json) を選択してください。");
                return;
            }

            let surveyData;
            try {
                const fileContent = await jsonFile.text();
                surveyData = JSON.parse(fileContent);
                if (!surveyData.title || !surveyData.question_groups || !surveyData.gas_endpoint_url) {
                     throw new Error("JSONの形式が正しくありません。'title', 'question_groups', 'gas_endpoint_url' フィールドが必要です。");
                }
            } catch (e) {
                showAdminError(`JSONファイルの読み込みまたは解析に失敗しました: ${e.message}`);
                return;
            }

            try {
                const surveyDocRef = doc(db, 'surveys', surveyId);
                const surveyDocSnap = await getDoc(surveyDocRef);

                if (surveyDocSnap.exists()) {
                    const overwrite = window.confirm(`アンケートID "${surveyId}" は既に存在します。上書きしますか？`);
                    if (!overwrite) {
                        showAdminError("保存をキャンセルしました。別のURLの末尾を指定してください。");
                        return;
                    }
                }

                await setDoc(surveyDocRef, surveyData);

                const surveyUrl = `${window.location.origin}${window.location.pathname.replace(/index\.html$/, '')}${surveyId}`;
                adminSuccessMessage.innerHTML = `アンケートを保存しました！<br>公開URL: <a href="${surveyUrl}" target="_blank" class="font-bold underline">${surveyUrl}</a>`;
                adminSuccessDisplay.classList.remove('hidden');

            } catch (error) {
                console.error("Firebaseへの保存に失敗しました:", error);
                showAdminError(`Firebaseへの保存に失敗しました: ${error.message}`);
            } finally {
                saveSurveyBtn.disabled = false;
                saveSurveyBtn.textContent = '保存してURLを生成';
            }
        }

        function showError(message) {
            errorDisplayMessage.textContent = message;
            errorDisplay.classList.remove('hidden');
            loadingSpinner.style.display = 'none';
            appContainer.classList.remove('hidden');
            document.getElementById('quiz-form').style.display = 'none';
            document.getElementById('navigation-controls').style.display = 'none';
            document.getElementById('form-header').style.display = 'none';
            document.getElementById('progress-container').style.display = 'none';
        }

        // --- アンケート描画・操作関連の関数群 (変更なし) ---
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1));[array[i], array[j]] = [array[j], array[i]]; } }
        function generatePage(groupId, pageNumber = 0) {
            const group = surveyJSONData.question_groups.find(g => g.id === groupId); if (!group) { console.error(`Group with ID '${groupId}' not found.`); return; }
            if (group.randomize && !group._shuffled) { shuffleArray(group.questions); group._shuffled = true; }
            const totalGroupPages = Math.ceil(group.questions.length / 20); if (pageNumber >= totalGroupPages) {
                const nextGroupId = findNextGroupIdForGroup(groupId); if (nextGroupId === "") { submitForm(); } else if (nextGroupId) { generatePage(nextGroupId, 0); } else { updateNavigation(); }
                return;
            }
            pageHistory = pageHistory.slice(0, currentPageIndex); pageHistory.push({ groupId, pageNumber, group }); currentPageIndex = pageHistory.length - 1; renderPageContent();
        }
        function renderPageContent() {
            questionsContainer.innerHTML = ''; const currentPageData = pageHistory[currentPageIndex]; if (!currentPageData) return; const { group, pageNumber } = currentPageData; const groupHeader = document.createElement('div'); groupHeader.className = 'border-l-4 border-blue-500 pl-4 py-2 bg-blue-50 rounded-r-lg mb-8'; groupHeader.innerHTML = `
        <h3 class="text-xl font-bold text-gray-800">${group.title}</h3>
        <p class="text-gray-600 mt-1">${group.description}</p>
    `; questionsContainer.appendChild(groupHeader); const startIndex = pageNumber * 20; const endIndex = Math.min(startIndex + 20, group.questions.length); const questionsToDisplay = group.questions.slice(startIndex, endIndex); questionsToDisplay.forEach((q, indexInPage) => { const overallQuestionNumber = startIndex + indexInPage; const questionData = { ...(group.defaults || {}), ...q }; const questionElement = createQuestionElement(questionData, overallQuestionNumber); questionsContainer.appendChild(questionElement); }); updateNavigation(); updateProgressBar();
        }
        function createQuestionElement(q, overallIndex) {
            const questionDiv = document.createElement('div'); questionDiv.className = 'question-block border-t pt-6'; questionDiv.id = `q-block-${q.id}`; let label = `<label for="${q.id}" class="block text-md font-medium text-gray-800 ${q.required ? 'required-label' : ''}">${overallIndex + 1}. ${q.label}</label>`; let helpText = q.help_text ? `<p class="text-sm text-gray-500 mt-1">${q.help_text}</p>` : ''; let inputHtml = ''; switch (q.type) {
                case 'text_short': inputHtml = `<input type="text" id="${q.id}" name="${q.id}" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="${q.placeholder || ''}">`; break; case 'text_long': inputHtml = `<textarea id="${q.id}" name="${q.id}" rows="4" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="${q.placeholder || ''}"></textarea>`; break; case 'number': inputHtml = `<input type="number" id="${q.id}" name="${q.id}" min="${q.min}" max="${q.max}" step="${q.step || 1}" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="${q.placeholder || ''}">`; break; case 'date': inputHtml = `<input type="date" id="${q.id}" name="${q.id}" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">`; break; case 'boolean': inputHtml = `<div class="mt-2 space-x-4">
                <label class="inline-flex items-center"><input type="radio" name="${q.id}" value="true" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2">${q.TrueLabel || 'はい'}</span></label>
                <label class="inline-flex items-center"><input type="radio" name="${q.id}" value="false" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2">${q.FalseLabel || 'いいえ'}</span></label>
            </div>`; break; case 'radio': inputHtml = '<div class="mt-2 space-y-2">'; q.options.forEach(opt => { inputHtml += `<label class="flex items-center"><input type="radio" name="${q.id}" value="${opt}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-3 block text-sm text-gray-700">${opt}</span></label>`; }); inputHtml += '</div>'; break; case 'checkbox': inputHtml = '<div class="mt-2 space-y-2">'; q.options.forEach(opt => { inputHtml += `<label class="flex items-center"><input type="checkbox" name="${q.id}" value="${opt}" class="h-4 w-4 rounded text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-3 block text-sm text-gray-700">${opt}</span></label>`; }); inputHtml += '</div>'; break; case 'pull_down': inputHtml = `<select id="${q.id}" name="${q.id}" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"><option value="">選択してください</option>`; q.options.forEach(opt => { inputHtml += `<option value="${opt}">${opt}</option>`; }); inputHtml += '</select>'; break; case 'scale': inputHtml = `<div class="mt-3 flex items-center justify-between space-x-2 sm:space-x-4">
                            <span class="text-sm text-gray-600 text-center w-1/5">${q.minLabel}</span>
                            <div class="flex-grow flex justify-around items-center">`; for (let i = q.min; i <= q.max; i++) {
                        inputHtml += `<label class="flex flex-col items-center cursor-pointer p-2 rounded-md hover:bg-gray-100">
                    <input type="radio" name="${q.id}" value="${i}" class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                    <span class="text-sm mt-1.5">${i}</span>
                </label>`;
                    }
                    inputHtml += `</div><span class="text-sm text-gray-600 text-center w-1/5">${q.maxLabel}</span></div>`; break; case 'slider': inputHtml = `<div class="mt-3">
                <input type="range" id="${q.id}" name="${q.id}" min="${q.min}" max="${q.max}" step="${q.step}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="document.getElementById('${q.id}-value').textContent = this.value">
                <div class="text-center mt-1"><span id="${q.id}-value" class="text-sm font-medium text-gray-700">${q.min}</span></div>
            </div>`; break; case 'matrix': inputHtml = '<div class="mt-2 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 border">'; inputHtml += '<thead><tr><th class="px-6 py-3 bg-gray-50"></th>'; q.options[1].forEach(col => inputHtml += `<th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`); inputHtml += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">'; q.options[0].forEach((row, rowIndex) => {
                        inputHtml += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row}</td>`; q.options[1].forEach((col, colIndex) => {
                            inputHtml += `<td class="px-0 py-0 whitespace-nowrap text-center">
                                    <label class="matrix-cell-label flex items-center justify-center h-full w-full">
                                        <input type="radio" name="${q.id}-${rowIndex}" value="${col}" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                    </label>
                                  </td>`;
                        }); inputHtml += '</tr>';
                    }); inputHtml += '</tbody></table></div>'; break; case 'multi_matrix': inputHtml = '<div class="mt-2 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 border">'; inputHtml += '<thead><tr><th class="px-6 py-3 bg-gray-50"></th>'; q.options[1].forEach(col => inputHtml += `<th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`); inputHtml += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">'; q.options[0].forEach((row, rowIndex) => {
                        inputHtml += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row}</td>`; q.options[1].forEach((col, colIndex) => {
                            inputHtml += `<td class="px-0 py-0 whitespace-nowrap text-center">
                                    <label class="matrix-cell-label flex items-center justify-center h-full w-full">
                                        <input type="checkbox" name="${q.id}-${rowIndex}[]" value="${col}" class="h-4 w-4 rounded text-blue-600 border-gray-300 focus:ring-blue-500">
                                    </label>
                                  </td>`;
                        }); inputHtml += '</tr>';
                    }); inputHtml += '</tbody></table></div>'; break; case 'email': inputHtml = `<input type="email" id="${q.id}" name="${q.id}" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="${q.placeholder || 'your@example.com'}">`; break; default: inputHtml = `<p class="text-red-500">Unsupported question type: ${q.type}</p>`;
            }
            questionDiv.innerHTML = label + helpText + inputHtml + `<div id="error-${q.id}" class="error-message"></div>`; restoreAnswer(q); return questionDiv;
        }
        function restoreAnswer(q) { setTimeout(() => { if (!answers[q.id]) return; const value = answers[q.id]; if (q.type === 'checkbox') { document.querySelectorAll(`input[name="${q.id}"]`).forEach(el => { if (value.includes(el.value)) el.checked = true; }); } else if (q.type === 'radio' || q.type === 'scale' || q.type === 'boolean') { const el = document.querySelector(`input[name="${q.id}"][value="${value}"]`); if (el) el.checked = true; } else if (q.type === 'matrix') { Object.entries(value).forEach(([rowIndex, colValue]) => { const el = document.querySelector(`input[name="${q.id}-${rowIndex}"][value="${colValue}"]`); if (el) el.checked = true; }); } else if (q.type === 'multi_matrix') { if (typeof value === 'object' && value !== null) { Object.entries(value).forEach(([rowIndex, selectedOptions]) => { if (Array.isArray(selectedOptions)) { selectedOptions.forEach(option => { const el = document.querySelector(`input[name="${q.id}-${rowIndex}[]"][value="${option}"]`); if (el) el.checked = true; }); } }); } } else { const el = document.getElementById(q.id); if (el) el.value = value; if (q.type === 'slider') { const valueEl = document.getElementById(`${q.id}-value`); if (valueEl) valueEl.textContent = value; } } }, 0); }
        function updateNavigation() {
            prevBtn.disabled = currentPageIndex === 0; const currentPageData = pageHistory[currentPageIndex]; if (!currentPageData) { nextBtn.classList.add('hidden'); submitBtn.classList.remove('hidden'); return; }
            const { groupId, pageNumber } = currentPageData; const group = surveyJSONData.question_groups.find(g => g.id === groupId); const totalGroupPages = Math.ceil(group.questions.length / 20); const isLastPageInGroup = (pageNumber + 1) >= totalGroupPages; const currentGroupIndex = surveyJSONData.question_groups.findIndex(g => g.id === groupId); const nextGroupExists = (currentGroupIndex + 1) < surveyJSONData.question_groups.length; const isLastPageOfSurvey = isLastPageInGroup && !findNextGroupIdForGroup(groupId); if (isLastPageOfSurvey) { nextBtn.classList.add('hidden'); submitBtn.classList.remove('hidden'); } else { nextBtn.classList.remove('hidden'); submitBtn.classList.add('hidden'); }
        }
        function updateProgressBar() {
            const currentPageData = pageHistory[currentPageIndex]; if (!currentPageData) { progressText.textContent = ''; return; }
            const { groupId, pageNumber } = currentPageData; const group = surveyJSONData.question_groups.find(g => g.id === groupId); const totalGroupPages = Math.ceil(group.questions.length / 20); progressText.textContent = `グループ: ${group.title} | ページ: ${pageNumber + 1}/${totalGroupPages}`;
        }
        function saveCurrentPageAnswers() { const pageData = pageHistory[currentPageIndex]; if (!pageData) return; const { group, pageNumber } = pageData; const startIndex = pageNumber * 20; const endIndex = Math.min(startIndex + 20, group.questions.length); const questionsOnCurrentPage = group.questions.slice(startIndex, endIndex); questionsOnCurrentPage.forEach(q => { const questionData = { ...(group.defaults || {}), ...q }; if (questionData.type === 'checkbox') { const checked = Array.from(document.querySelectorAll(`input[name="${questionData.id}"]:checked`)).map(el => el.value); answers[questionData.id] = checked; } else if (questionData.type === 'radio' || questionData.type === 'scale' || questionData.type === 'boolean') { const el = document.querySelector(`input[name="${questionData.id}"]:checked`); if (el) answers[questionData.id] = el.value; } else if (questionData.type === 'matrix') { answers[questionData.id] = {}; questionData.options[0].forEach((row, rowIndex) => { const el = document.querySelector(`input[name="${questionData.id}-${rowIndex}"]:checked`); if (el) answers[questionData.id][rowIndex] = el.value; }); } else if (questionData.type === 'multi_matrix') { answers[questionData.id] = {}; questionData.options[0].forEach((row, rowIndex) => { const checked = Array.from(document.querySelectorAll(`input[name="${questionData.id}-${rowIndex}[]"]:checked`)).map(el => el.value); answers[questionData.id][rowIndex] = checked; }); } else { const el = document.getElementById(q.id); if (el) answers[q.id] = el.value; } }); }
        function validateCurrentPage() {
            let isValid = true; const pageData = pageHistory[currentPageIndex]; if (!pageData) return false; const { group, pageNumber } = pageData; const startIndex = pageNumber * 20; const endIndex = Math.min(startIndex + 20, group.questions.length); const questionsOnCurrentPage = group.questions.slice(startIndex, endIndex); questionsOnCurrentPage.forEach(q => {
                const questionData = { ...(group.defaults || {}), ...q }; const errorEl = document.getElementById(`error-${questionData.id}`); if (errorEl) { errorEl.textContent = ''; }
                if (!questionData.required) return; let answered = false; const answer = answers[questionData.id]; if (questionData.type === 'checkbox') { answered = answer && answer.length > 0; } else if (questionData.type === 'matrix') { answered = answer && Object.keys(answer).length === questionData.options[0].length; } else if (questionData.type === 'multi_matrix') {
                    answered = answer && Object.keys(answer).length === questionData.options[0].length; if (answered) {
                        for (const rowIndex in answer) {
                            if (answer[rowIndex].length === 0) { answered = false; break; }
                            if (typeof answer[rowIndex] === 'object' && Object.keys(answer[rowIndex]).length === 0 && !Array.isArray(answer[rowIndex])) { answered = false; break; }
                            if (Array.isArray(answer[rowIndex]) && answer[rowIndex].length === 0) { answered = false; break; }
                        }
                    }
                    if (!answered && errorEl) { errorEl.textContent = '全ての行で少なくとも1つ選択してください。'; }
                } else if (questionData.type === 'email') { const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; answered = answer && emailRegex.test(answer); if (!answered && errorEl) { errorEl.textContent = '有効なメールアドレスを入力してください。'; } } else { answered = answer !== undefined && answer !== null && answer !== ''; }
                if (!answered) { isValid = false; if (errorEl) { if (questionData.type !== 'email' || errorEl.textContent === '') { errorEl.textContent = 'この質問は必須です。'; } } }
            }); return isValid;
        }
        function findNextGroupIdForGroup(currentGroupId) {
            const group = surveyJSONData.question_groups.find(g => g.id === currentGroupId); if (!group) return null; for (const q of group.questions) { if (q.next) { const answer = answers[q.id]; if (answer !== undefined && q.next.hasOwnProperty(answer)) { return q.next[answer]; } } }
            if (group.next !== undefined) { return group.next; }
            const currentGroupIndex = surveyJSONData.question_groups.findIndex(g => g.id === currentGroupId); const nextGroup = surveyJSONData.question_groups[currentGroupIndex + 1]; return nextGroup ? nextGroup.id : null;
        }
        nextBtn.addEventListener('click', () => { saveCurrentPageAnswers(); if (validateCurrentPage()) { const currentPageData = pageHistory[currentPageIndex]; if (!currentPageData) return; const { groupId, pageNumber } = currentPageData; const group = surveyJSONData.question_groups.find(g => g.id === groupId); const totalGroupQuestions = group.questions.length; const totalGroupPages = Math.ceil(totalGroupQuestions / 20); if ((pageNumber + 1) < totalGroupPages) { currentPageIndex++; pageHistory[currentPageIndex] = { groupId, pageNumber: pageNumber + 1, group }; renderPageContent(); window.scrollTo(0, 0); } else { const nextGroupId = findNextGroupIdForGroup(groupId); if (nextGroupId === "") { submitForm(); } else if (nextGroupId) { generatePage(nextGroupId, 0); window.scrollTo(0, 0); } else { updateNavigation(); } } } });
        prevBtn.addEventListener('click', () => { saveCurrentPageAnswers(); if (currentPageIndex > 0) { currentPageIndex--; renderPageContent(); window.scrollTo(0, 0); } }); submitBtn.addEventListener('click', () => { saveCurrentPageAnswers(); if (validateCurrentPage()) { submitForm(); } });
        function getQuestionLabelFromId(questionId) {
            for (const group of surveyJSONData.question_groups) { for (const q of group.questions) { if (q.id === questionId) { return q.label; } } }
            return questionId;
        }
        function formatAnswerValue(questionId, value) {
            if (Array.isArray(value)) { return value.join(', '); } else if (typeof value === 'object' && value !== null) {
                const question = surveyJSONData.question_groups.flatMap(g => g.questions).find(q => q.id === questionId); if (question && (question.type === 'matrix' || question.type === 'multi_matrix') && question.options && question.options[0]) {
                    return Object.entries(value).map(([rowIndexStr, colValue]) => {
                        const rowIndex = parseInt(rowIndexStr); const rowLabel = question.options[0][rowIndex]; if (Array.isArray(colValue)) { return `<strong>${rowLabel}:</strong> ${colValue.join(', ')}`; }
                        return `<strong>${rowLabel}:</strong> ${colValue}`;
                    }).join('<br>');
                }
                return JSON.stringify(value, null, 2);
            }
            if (typeof value === 'string') { if (value === 'true') return 'はい'; if (value === 'false') return 'いいえ'; }
            return String(value);
        }
        function generateHtmlEmailBody(answers) {
            let htmlContent = `
        <div style="font-family: 'Noto Sans JP', sans-serif, sans-serif; max-width: 600px; margin: auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-color: #ffffff;">
            <h2 style="color: #333; text-align: center; margin-bottom: 20px;">アンケート回答結果</h2>
            <p style="color: #555; margin-bottom: 10px;"><strong>回答日時:</strong> ${new Date().toLocaleString('ja-JP', { timeZoneName: 'short' })}</p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                    <tr>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd; background-color: #f8f8f8; text-align: left; color: #666; width: 30%;">質問</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd; background-color: #f8f8f8; text-align: left; color: #666;">回答</th>
                    </tr>
                </thead>
                <tbody>
    `; for (const [key, value] of Object.entries(answers)) {
                const question = surveyJSONData.question_groups.flatMap(g => g.questions).find(q => q.id === key); if (question && question.type === 'email') { continue; }
                htmlContent += `
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #eee; vertical-align: top; color: #333;">${getQuestionLabelFromId(key)}</td>
                <td style="padding: 10px; border-bottom: 1px solid #eee; color: #555;">${formatAnswerValue(key, value)}</td>
            </tr>
        `;
            }
            htmlContent += `
                </tbody>
            </table>
            <p style="margin-top: 30px; text-align: center; color: #888; font-size: 0.9em;">このメールは自動送信されたものです。</p>
        </div>
    `; return htmlContent;
        }
        async function submitForm() {
            submitBtn.disabled = true; submitBtn.textContent = '送信中...'; nextBtn.classList.add('hidden'); prevBtn.disabled = true; const gasEndpointUrl = surveyJSONData.gas_endpoint_url; if (!gasEndpointUrl || gasEndpointUrl === "YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE") { showError('アンケートのJSONデータにGASのエンドポイントURLが正しく設定されていません。「gas_endpoint_url」をご確認ください。'); submitBtn.disabled = false; submitBtn.textContent = '送信'; prevBtn.disabled = false; return; }
            const htmlEmailContent = generateHtmlEmailBody(answers); const payloadForAppsScript = { ...answers, _email_html_body: htmlEmailContent }; try { const response = await fetch(gasEndpointUrl, { method: 'POST', body: JSON.stringify(payloadForAppsScript), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }); const result = await response.json(); if (result.status === 'success') { console.log('Google Apps Script にデータを送信しました。メール送信も成功しました。'); appContainer.classList.add('hidden'); thankYouMessage.classList.remove('hidden'); } else { console.error('Google Apps Script からのエラー:', result.message); showError(`送信エラー: ${result.message}`); submitBtn.disabled = false; submitBtn.textContent = '送信'; prevBtn.disabled = false; } } catch (error) { console.error('送信エラー:', error); showError('アンケートの送信に失敗しました。時間をおいて再度お試しください。'); submitBtn.disabled = false; submitBtn.textContent = '送信'; prevBtn.disabled = false; }
        }
    </script>
</body>
</html>